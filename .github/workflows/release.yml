name: Build and Release XCFrameworks

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      mlx_swift_lm_version:
        description: 'mlx-swift-lm version to build (e.g., 0.3.0 or main)'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: macos-14  # Apple Silicon runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Print environment info
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "Swift version:"
          swift --version
          echo ""
          echo "Available SDKs:"
          xcodebuild -showsdks

      - name: Build XCFrameworks
        run: |
          chmod +x Scripts/build-xcframework.sh
          ./Scripts/build-xcframework.sh "${{ github.event.inputs.mlx_swift_lm_version || github.ref_name }}"
        env:
          MLX_SWIFT_LM_VERSION: ${{ github.event.inputs.mlx_swift_lm_version || github.ref_name }}

      - name: Read checksums
        id: checksums
        run: |
          echo "mlxlmcommon=$(cat output/MLXLMCommon.xcframework.zip.sha256)" >> $GITHUB_OUTPUT
          echo "mlxllm=$(cat output/MLXLLM.xcframework.zip.sha256)" >> $GITHUB_OUTPUT
          echo "mlxvlm=$(cat output/MLXVLM.xcframework.zip.sha256)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            output/MLXLMCommon.xcframework.zip
            output/MLXLLM.xcframework.zip
            output/MLXVLM.xcframework.zip
          body: |
            ## MLXBinary ${{ github.ref_name }}

            Pre-built XCFrameworks for mlx-swift-lm.

            ### Modules
            - **MLXLLM** - Large Language Model support
            - **MLXVLM** - Vision Language Model support
            - **MLXLMCommon** - Common utilities

            ### Checksums (SHA256)
            ```
            MLXLMCommon: ${{ steps.checksums.outputs.mlxlmcommon }}
            MLXLLM: ${{ steps.checksums.outputs.mlxllm }}
            MLXVLM: ${{ steps.checksums.outputs.mlxvlm }}
            ```

            ### Usage

            Add to your `Package.swift`:

            ```swift
            dependencies: [
                .package(url: "https://github.com/waylybaye/MLXBinary.git", from: "${{ github.ref_name }}")
            ]
            ```

            Then add the dependency to your target:

            ```swift
            .target(
                name: "YourApp",
                dependencies: [
                    .product(name: "MLXLLM", package: "MLXBinary"),
                    // or use MLXBinary for all modules
                ]
            )
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (for manual workflow)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: xcframeworks
          path: |
            output/*.zip
            output/*.sha256
          retention-days: 7

      - name: Print checksums for manual update
        run: |
          echo ""
          echo "=============================================="
          echo "Update Package.swift with these checksums:"
          echo "=============================================="
          echo ""
          echo "MLXLMCommon: ${{ steps.checksums.outputs.mlxlmcommon }}"
          echo "MLXLLM: ${{ steps.checksums.outputs.mlxllm }}"
          echo "MLXVLM: ${{ steps.checksums.outputs.mlxvlm }}"
          echo ""
